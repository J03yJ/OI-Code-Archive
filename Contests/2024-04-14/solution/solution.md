# T1 大魔法师（magic）

### 60分

容易发现：每个手下有三种选择方式，不被选择/被选择/被忽略

用搜索$3^n$时间复杂度搜索

### 100分

$n$很小，所以采用折半搜索

用map/unordered_map/hash表存储折半搜索的结果，再进行合并，所以总时间复杂度为$O(3^{\frac{n}{2}}\times n)$

# T2 黑洞（blackhole）

### 30分

枚举每个黑洞，枚举每个点，通过模拟判断是否依旧留在棋盘内，时间复杂度为$O(Tn^2m^2l)$

### 60分

暂时不考虑黑洞，对于操作序列，容易发现最后剩下的棋子在棋盘上是一块矩形$[l_x,r_x]\times [l_y,r_y]$，再考虑黑洞。

可以得到经过操作序列后所有的位移偏移量$(dx,dy)$，我们将这些位置$(dx,dy)$记录

维护黑洞在每个位置$(x',y')$上吞噬的棋子数量，容易发现吞噬的棋子$(x,y)$满足$(x+dx,y+dy)=(x',y')$且$x\in [l_x,r_x],y\in[l_y,r_y]$且之前没被吞噬过

对于没吞噬过这个条件，可以通过对$(dx,dy)$去重满足

那么对于每个$(dx,dy)\in[l_x,r_x]\times[l_y,r_y]$，可以发现会使得位置$(x',y')\in[l_x+dx,r_x+dx]\times [l_y+dy,r_y+dy]$上的黑洞吞噬棋子数量+1

暴力枚举$(dx,dy)$，暴力维护黑洞吞噬棋子数量，时间复杂度为$O( Tn ml)$

### 100分

发现先矩阵修改，再单点查询，差分后二维前缀和维护。

时间复杂度为$O(T(nm+l))$

# T3 任务安排 

问题答案为所有合法排列的逆序对数的期望

### 20分

枚举所有合法排列，求逆序对数量，时间复杂度为$O(n!nlgn)$

### 额外10分

求逆序对数量

### 100分

我们可以用$\frac{总逆序对数}{合法排列数}$计算出期望

考虑总方案数

先按$a_i$从小到大排序为$c_i $，设$c_i$排序前在数列中的位置为$b_i $

总方案数
$$
S=\prod_{i=1}^{n}(c_i-i+1)
$$
考虑数对$(i,j),i<j,p_i>p_j$对总逆序对数的贡献

1、$a_i=a_j$ ，显然$p_i>p_j$和$p_i<p_j$的概率相同，所以对总逆序对数的贡献为$\frac{S}{2}$

2、$a_i<a_j$ ，此时$p_j<p_i<a_i<a_j$，所以容易发现此时的方案数和令$a_j=a_i$时的方案数相同

记作$S'$，对总逆序对数的贡献为$\frac{S'}{2}$，现在记$i=b_i$和$j=b_j$

$c_1,c_2,...,c_i,c_{i+1},c_{i+2},...,c_j,c_{j+1},...,c_n$变为了$c_1,c_2,...,c_i,c_j',c_{i+1},c_{i+2},...,c_{j-1},c_{j+1},...,c_n$

故
$$
\begin{aligned}
S'&=\prod_{k=1}^n(c_k'-k+1)\\&=\prod_{k=1}^{i}(c_k-k+1)(c_i-i)\prod_{k=i+1}^{j-1}(c_k-k)\prod_{k=j+1}^{n}(c_k-k+1)
\end{aligned}
$$
可以用前缀积后缀积快速计算，记$pree_i=\prod_{j=1}^{i}c_j-j，pre_i=\prod_{j=1}^{i}c_j-j+1$。

注意这儿$c_j\ge j$，可能会出现$pree_i=0$的情况

当$pre_i= 0$时不妨在前缀积时当作1处理以保证$\prod_{k=i+1}^{j-1}c_k-k=\frac{pre_{j-1}}{pre_i}[c_k>k,\forall k=i+1,i+2,...,j-1]$
$$
S'=\frac{pre_i\times(c_i-i)}{pree_{i}}\times pree_{j-1}\times \frac{pre_n}{pre_j}[c_k>k,\forall k=i+1,i+2,...j-1]
$$
考虑最终答案$\frac{1}{2}\sum_{i=1}^{n}\sum_{j=i+1}^{n}[a_i>a_j]S'=\frac{1}{2}\sum_{i=1}^{n}\sum_{j=1+i}^{n}[b_i>b_j]S'$

枚举 $i$ ,然后需要维护$\sum_{j=i+1}^{n}[b_i>b_j]S'=\frac{pre_i\times(c_i-i)}{pree_{i}}\times pre_n\sum_{j=i+1}^{n}[b_i>b_j]\frac{pree_{j-1}}{pre_j}[c_k>k,\forall k=i+1,i+2,...j-1]$

只需要维护二位数点，从大到小枚举$i$，树状数组维护

3、$a_i>a_j$ 同理可得

逆元可以用费马小定理求出

时间复杂度为$O(nlgn)$

# T4 游乐园

### 20分

暴力搜索枚举所有合法串再计算LCS

### 80分

发现至多浪费2个位置

如果$T_i $发生匹配，一定与$S_{i-2},S_{i-1},S_i,S_{i+1},S_{i+2}$发生了匹配

设$f$为LCS数组

故而我们只需要记录$f[i][i-2],f[i][i-1],f[i][i],f[i][i+1],f[i][i+2]$


$$
\begin{aligned}
f[i][i-2]&=max(f[i-1][i-2],f[i][i-3],f[i-1][i-3]+(T_i==S_{i-2}))\\
f[i][i-1]&=max(f[i-1][i-1],f[i][i-2],f[i-1][i-2]+(T_i==S_{i-1}))\\
f[i][i]&=max(f[i-1][i],f[i][i-1],f[i-1][i-1]+(T_i==S_{i}))\\f[i][i+1]&=max(f[i-1][i+1],f[i][i],f[i-1][i]+(T_i==S_{i+1}))\\f[i][i+2]&=
max(f[i-1][i+2],f[i][i+1],f[i-1][i+1]+(T_i==S_{i+2}))
\end{aligned}
$$
$f[n][n]\ge n-2$，而$f[i][j]$对$f[n][n]$最大贡献为$f[i][j]+min(n-i,n-j)$

显然不可能有转移$f[i][i-3]->f[i][i-2],f[i-1][i+2]->f[i][i+1]$

故我们可以从$f[i-1][i-3],f[i-1][i-2],f[i-1][i-1],f[i-1][i],f[i-1][i+1]->f[i][i-2],f[i][i-1],f[i][i],f[i][i+1],f[i][i+2]$

而此时$i-2\le f[i][i-2]\le i-2,0\le f[i][j]-f[i][j-1]\le 1$，可以差分后用01序列表示

转移转移枚举下一个是什么，时间复杂度为$O(26n2^5)$

### 100分

只需要知道$T_j$与$S_{i-2},S_{i-1},S_i,S_{i+1},S_{i+1},S_{i+2}$的相对关系，可以将26->5

时间复杂度为$O(5n2^{5})$



